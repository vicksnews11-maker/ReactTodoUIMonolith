trigger: none

pool: Default

stages:
# FRONTEND BUILD STAGE---------------------------------------------------
- stage: Build
  displayName: "Build Frontend"
  jobs:
  - job: Build_Frontend
    steps:
      - task: NodeTool@0
        displayName: "Install Node v18"
        inputs:
          versionSource: 'spec'
          versionSpec: '18.x'
      - task: PowerShell@2
        displayName: "Build React Application"
        inputs:
          targetType: 'inline'
          script: |
            npm ci
            npm run build
      - task: PublishBuildArtifacts@1
        displayName: "Publish Frontend Artifact"
        inputs:
          PathtoPublish: 'build'
          ArtifactName: 'frontend_build'
          publishLocation: 'Container'
# FRONTEND DEPLOY STAGE---------------------------------------------------
- stage: Deploy
  displayName: "Deploy Frontend"
  dependsOn: Build
  jobs:
  - job: Deploy_Frontend
    steps:
      - task: DownloadBuildArtifacts@1
        displayName: "Download Frontend Artifact"
        inputs:
          buildType: 'current'
          downloadType: 'single'
          artifactName: 'frontend_build'
          downloadPath: '$(Pipeline.Workspace)/frontend'

      - task: CopyFilesOverSSH@0
        displayName: "Copy React Build to Temp"
        inputs:
          sshEndpoint: "frontend-ssh"
          sourceFolder: "$(Pipeline.Workspace)/frontend/frontend_build"
          contents: "**"
          targetFolder: "/tmp/react_build"
          overwrite: true
# Fix permissions with sudo
      - task: SSH@0
        displayName: "Fix Permissions"
        inputs:
          sshEndpoint: 'frontend-ssh'
          runOptions: 'inline'
          inline: |
            sudo rm -rf /var/www/html/*
            sudo mkdir -p /var/www/html
            sudo mv /tmp/react_build/* /var/www/html/
            sudo chown -R www-data:www-data /var/www/html
          readyTimeout: '20000'  
       
      - task: SSH@0
        displayName: "Install & Configure NGINX"
        inputs:
         sshEndpoint: 'frontend-ssh'
         runOptions: 'inline'
         inline: |
          echo "Checking if NGINX is installed..."
          if ! command -v nginx >/dev/null 2>&1; then
            echo "NGINX not found â€” installing..."
            sudo apt-get update -y
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y nginx
          else
            echo "NGINX already installed."
          fi

          echo "Configuring NGINX..."
          sudo bash -c 'cat > /etc/nginx/sites-available/frontend <<EOF
            server {
                listen 80;
                root /var/www/frontend;
                index index.html;
                location / {
                    try_files \$uri /index.html;
                }
            }
            EOF'

          sudo ln -sf /etc/nginx/sites-available/frontend /etc/nginx/sites-enabled/frontend
          sudo rm -f /etc/nginx/sites-enabled/default

          echo "Restarting NGINX..."
          sudo systemctl enable nginx
          sudo systemctl restart nginx
          echo "NGINX restarted successfully."
          readyTimeout: '20000'
