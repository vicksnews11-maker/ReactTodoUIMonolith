trigger: none

pool: Default

stages:

# ---------------------------------------------------
# FRONTEND BUILD STAGE
# ---------------------------------------------------
- stage: Build
  displayName: "Build Frontend"
  jobs:
  - job: Build_Frontend
    steps:

    # Install Node.js
    - task: NodeTool@0
      displayName: "Install Node v18"
      inputs:
        versionSource: 'spec'
        versionSpec: '18.x'

    # ✅ Build React App
    - script: |
        cd <REACT_FOLDER_PATH>
        npm ci
        npm run build
      displayName: "Build React Application"

    # ✅ Debug (optional but helps identify paths)
    - script: |
        dir <REACT_FOLDER_PATH> /s
      displayName: "Debug Folder Structure"

    # ✅ Publish build artifact
    - task: PublishBuildArtifacts@1
      displayName: "Publish Frontend Artifact"
      inputs:
        PathtoPublish: '<REACT_FOLDER_PATH>/build'
        ArtifactName: 'frontend_build'
        publishLocation: 'Container'


# ---------------------------------------------------
# FRONTEND DEPLOY STAGE
# ---------------------------------------------------
- stage: Deploy
  displayName: "Deploy Frontend"
  dependsOn: Build
  jobs:
  - job: Deploy_Frontend
    steps:

    # ✅ Download artifact from build stage
    - task: DownloadBuildArtifacts@1
      displayName: "Download Frontend Artifact"
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'frontend_build'
        downloadPath: '$(Pipeline.Workspace)/frontend'

    # ✅ Copy build files to Linux VM
    - task: CopyFilesOverSSH@0
      displayName: "Copy React Build to NGINX Server"
      inputs:
        sshEndpoint: 'frontend-ssh'
        sourceFolder: '$(Pipeline.Workspace)/frontend/frontend_build/build'
        contents: '**'
        targetFolder: '/var/www/html'
        overwrite: true

    # ✅ Restart NGINX
    - task: SSH@0
      displayName: "Restart NGINX"
      inputs:
        sshEndpoint: 'frontend-ssh'
        runOptions: 'inline'
        inline: |
          sudo systemctl restart nginx
        readyTimeout: '20000'
